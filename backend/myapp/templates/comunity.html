<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì»¤ë®¤ë‹ˆí‹°</title>

  <!-- Djangoì˜ static íƒœê·¸ ì‚¬ìš© -->
  {% load static %}

  <!-- CSS ê²½ë¡œ ìˆ˜ì • -->
  <link rel="stylesheet" href="{% static 'css/reset.css' %}">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">

  <!-- ì™¸ë¶€ í°íŠ¸ ë° ì•„ì´ì½˜ ë¡œë“œ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR&display=swap" rel="stylesheet">
</head>
<body>
  <div class="frame2">
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="header">
        <a href="{% url 'main' %}">
            <!-- ì´ë¯¸ì§€ ê²½ë¡œ ìˆ˜ì • -->
            <img src="{% static 'img/logo.png' %}" alt="ë¡œê³ ">
        </a>
      <ul>
        <!-- URL ê²½ë¡œ ìˆ˜ì • -->
        <li><a href="{% url 'main' %}" class="neon-effect">í™ˆ</a></li>
        <li><a href="{% url 'gamerule' %}" class="neon-effect">ê²Œì„ë°©ë²•</a></li>
        <li><a href="{% url 'rank' %}" class="neon-effect">ë­í‚¹</a></li>
        <li><a href="{% url 'comunity' %}" class="neon-effect">ì»¤ë®¤ë‹ˆí‹°</a></li>
        <li><a href="{% url 'mypage' %}" class="neon-effect">ë‚´ì •ë³´</a></li>
      </ul>
    </nav>

    <!-- ê²€ìƒ‰ ë°” -->
    <div class="search-bar">
        <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button>ê²€ìƒ‰</button>
    </div>

    <div class="container">
        <!-- ë©”ì¸ ì½˜í…ì¸  (ììœ ê²Œì‹œíŒ) -->
        <div class="main-content">
            <h2 class="board-title">ììœ ê²Œì‹œíŒ</h2>

            <!-- ê²Œì‹œë¬¼ ë¦¬ìŠ¤íŠ¸ -->
            <div id="board-list" class="post-list">
              {% for post in posts %}
              <div class="post-item">
                <div class="post-title">
                  <a href="#" onclick="showPostDetail({{ post.id }})">{{ post.title }}</a>
                </div>
                <div class="post-info">
                    ì‘ì„±ì: {{ post.author.nickname}}
                    ì‘ì„±ì¼: {{ post.created_at|date:"Y-m-d" }}</div>
              </div>
              {% endfor %}
            </div>

            <!-- ê²Œì‹œë¬¼ ìƒì„¸ ë³´ê¸° (ìˆ¨ê¹€ ì²˜ë¦¬ëœ ìƒíƒœë¡œ ì‹œì‘) -->
            <div id="post-detail" style="display: none;">
                <div class="post-container">
                    <div class="post-header">
                        <h2 id="detail-title" data-post-id="{{post.id}}">{{ post.title}}</h2>
                        <p id="detail-author"></p>
                    </div>
                    <div class="post-content">
                        <p id="detail-content"></p>
                        <p id="detail-author"></p>

                        <!-- ë¹„ë””ì˜¤ ì¹´ë“œ -->
                        {% if post.video %}
                            <div class="video-card" id="video-container">
                                <div class="video-frame">
                                    <video controls class="video-content" id="post-video">
                                        <source src="{{ post.video.url }}" type="video/mp4">
                                        ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                    </video>
                                </div>
                            </div>
                        {% else %}
                        <!-- ë¹„ë””ì˜¤ê°€ ì—†ëŠ” ê²½ìš° ìŠ¤íƒ€ì¼ ìœ ì§€ -->
                            <div class="video-card" id="video-container" style="display:none;">
                                <div class="video-frame">
                                    <video controls class="video-content" id="post-video">
                                        <source id="video-source" type="video/mp4">
                                        ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                    </video>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="post-actions">
                        <button class="like-btn" onclick="increaseLike()">ğŸ‘ ì¢‹ì•„ìš”</button> 
                        <span id="like-count">0</span> Â· ğŸ’¬ ëŒ“ê¸€ <span id="comment-count">0</span>
                    </div>
                </div>

                <!-- ëŒ“ê¸€ ì…ë ¥ -->
                <div class="comment-section">
                    <form id="comment-form" method="post">
                        {% csrf_token %}
                        <textarea id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <button onclick="submitComment()">ëŒ“ê¸€ ë“±ë¡</button>
                    </form>
                </div>

                <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
                <div id="comment-list">
                    {% for comment in comments %}
                        <div class="comment">
                            <p><strong>{{ comment.author.nickname }}</strong>: {{ comment.content }}</p>
                            <span class="comment-date">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                        </div>
                    {% endfor %}
                </div>
                    
                <!-- ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
                <button onclick="backToList()">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        </div>

        <!-- ìš°ì¸¡ ì‚¬ì´ë“œë°” (ì¡°íšŒ ë§ì€ ê¸€, HOT ê²Œì‹œë¬¼, BEST ê²Œì‹œë¬¼) -->
        <div class="right-sidebar">
            <div class="popular-posts">
                <h3>ì‹¤ì‹œê°„ ì¸ê¸° ê¸€</h3>
                <div class="popular-post">
                    <div class="post-title">ì¸ê¸° ê²Œì‹œë¬¼ 1</div>
                    <div class="post-stats">ì¢‹ì•„ìš”: 10 | ëŒ“ê¸€: 5</div>
                </div>
                <div class="popular-post">
                    <div class="post-title">ì¸ê¸° ê²Œì‹œë¬¼ 2</div>
                    <div class="post-stats">ì¢‹ì•„ìš”: 8 | ëŒ“ê¸€: 3</div>
                </div>
            </div>

            <div class="popular-posts">
                <h3>HOT ê²Œì‹œë¬¼</h3>
                <div class="popular-post">
                    <div class="post-title">HOT ê²Œì‹œë¬¼ 1</div>
                    <div class="post-stats">ì¢‹ì•„ìš”: 13 | ëŒ“ê¸€: 6</div>
                </div>
            </div>

            <div class="popular-posts">
                <h3>BEST ê²Œì‹œë¬¼</h3>
                <div class="popular-post">
                    <div class="post-title">BEST ê²Œì‹œë¬¼ 1</div>
                    <div class="post-stats">ì¢‹ì•„ìš”: 25 | ëŒ“ê¸€: 10</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ -->
    <div class="new-post" id="new-post-section">
        <input type="text" placeholder="ìƒˆ ê¸€ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”!" disabled />
        <button class="new-post-btn" onclick="window.location.href={% url 'write' %};">
            <i class="fa-solid fa-pencil" style="color: #63E6BE;"></i> ìƒˆ ê¸€ ì‘ì„±
        </button>
    </div>

    <div class="footer-space"></div>
    </div>

<script>

    window.onload = function() {
        // ê²Œì‹œê¸€ ëª©ë¡ì„ ì„œë²„ì—ì„œ ë°›ì•„ì„œ ë Œë”ë§
        fetch('/comunity/')
        .then(response => response.json())
        .then(posts => {
            const postListContainer = document.getElementById('board-list');

            // ì„œë²„ì—ì„œ ë°›ì€ ê²Œì‹œë¬¼ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
            posts.forEach((post, index) => {
                const postItem = `
                    <div class="post-item">
                        <div class="post-title">
                            <a href="#" onclick="showPostDetail(${post.id})">${post.title}</a>
                        </div>
                        <div class="post-info">ì‘ì„±ì¼: ${post.created_at}</div>
                    </div>
                `;
                postListContainer.innerHTML += postItem;
            });
        });
        
    };
    
    function showPostDetail(postId) {
        // ì„œë²„ì—ì„œ íŠ¹ì • ê²Œì‹œë¬¼ ê°€ì ¸ì˜¤ê¸°
        fetch(`/comunity/post/${postId}/`)
        .then(response => response.json())
        .then(post => {
            // ì œëª©ê³¼ ë‚´ìš© í‘œì‹œ
            document.getElementById("detail-title").innerText = post.title;
            document.getElementById("detail-content").innerText = post.content;
            document.getElementById("detail-author").innerText = "ì‘ì„±ì: " + post.author;
        
            // ë™ì˜ìƒì´ ìˆëŠ” ê²½ìš° í‘œì‹œ
            if (post.video_url) {
                const videoElement = document.getElementById("post-video");
                document.getElementById("video-container").style.display = "block";
                videoElement.src = post.video_url;
            } else {
                document.getElementById("video-container").style.display = "none";
            }

             // ëŒ“ê¸€ í‘œì‹œ
            const commentList = document.getElementById("comment-list");
            commentList.innerHTML = "";  // ê¸°ì¡´ ëŒ“ê¸€ ëª©ë¡ ì´ˆê¸°í™”
            post.comments.forEach(comment => {
                const commentItem = document.createElement("div");
                commentItem.classList.add("comment");
                commentItem.innerText = `${comment.author}: ${comment.content}`;
                commentList.appendChild(commentItem);
            });
        
            // ê²Œì‹œë¬¼ ë¦¬ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
            document.getElementById("board-list").style.display = "none";
            // ìƒì„¸ë³´ê¸° ì„¹ì…˜ ë³´ì´ê¸°
            document.getElementById("post-detail").style.display = "block";
            // ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.getElementById("new-post-section").style.display = "none";
        });
    }

    function backToList() {
        document.getElementById("board-list").style.display = "block";
        document.getElementById("post-detail").style.display = "none";
        document.getElementById("new-post-section").style.display = "flex";
    }

    let likeCount = 0;
    function increaseLike() {
        likeCount++;
        document.getElementById("like-count").innerText = likeCount;
    }

    function submitComment() {
        const commentInput = document.getElementById("comment-input");
        const commentText = commentInput.value.trim();  // ê³µë°± ì œê±° í›„ í™•ì¸
        const postId = document.querySelector("#detail-title").getAttribute("data-post-id");
    
        console.log("ëŒ“ê¸€ ë‚´ìš©:", commentText);  // ë””ë²„ê¹…ìš©
    
        if (!commentText) {
            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;  // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨
        }
    
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
        fetch(`/submit_comment/${postId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
            },
            body: new URLSearchParams({ "content": commentText })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
            }
            return response.json();
        })
        .then(data => {
            if (data.status === "success") {
                const commentList = document.getElementById("comment-list");
                const newComment = document.createElement("div");
                newComment.classList.add("comment");
                newComment.innerHTML = `
                    <p><strong>${data.author}</strong>: ${data.content}</p>
                    <span class="comment-date">${data.created_at}</span>
                `;
                commentList.appendChild(newComment);
                commentInput.value = "";  // ëŒ“ê¸€ ì…ë ¥ ì´ˆê¸°í™”
            } else {
                alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + data.message);
            }
        })
        .catch(error => {
            console.error("Error submitting comment:", error);
            alert("ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }
    
    

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
</script>
</body>
</html>
